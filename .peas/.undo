{
  "Update": {
    "id": "peas-td52k",
    "file_path": "D:\\Development\\Shared\\PROJECT_LAB\\peas\\.peas\\peas-td52k--refactor-to-3-layer-architecture-tree-page-table-r.md",
    "previous_content": "+++\nid = \"peas-td52k\"\ntitle = \"Refactor to 3-layer architecture: tree/page-table/render\"\ntype = \"feature\"\nstatus = \"todo\"\npriority = \"normal\"\ncreated = \"2026-01-19T19:30:40.024596200Z\"\nupdated = \"2026-01-19T19:30:40.024596200Z\"\n+++\n\nRedesign the TUI rendering system to use a clean 3-layer architecture that separates concerns and makes the code more maintainable and extensible.\n\n## Architecture Layers\n\n### Layer 1: Ticket Tree (Render-Agnostic)\n- Pure data structure representing the complete ticket hierarchy\n- Contains all relationships, dependencies, and ordering logic\n- Completely agnostic to rendering - could support multiple output formats (TUI, PDF, HTML, etc.)\n- Built from filtered_peas using hierarchical relationships\n- Contains TreeNode with depth, parent_lines, is_last, etc.\n\n### Layer 2: Page Table (Viewport-Aware)\n- Takes the ticket tree and chunks it into pages based on available height\n- Knows about current terminal height and recalculates when it changes\n- Handles parent context rows by inserting references to parent nodes\n- Uses references to TreeNode from Layer 1 (no data duplication)\n- Produces a structured representation of what should appear on each page\n- Each page entry contains: item refs, parent context refs, start/end indices\n\n### Layer 3: Rendering (Terminal Output)\n- Relatively \"dumb\" layer that just draws the page table to the terminal\n- Takes page data from Layer 2 and renders using ratatui\n- Handles styling, colors, highlighting, selection indicators\n- Should not contain pagination logic or tree traversal logic\n\n## Benefits\n\n1. **Separation of Concerns**: Each layer has a single, well-defined responsibility\n2. **Testability**: Each layer can be tested independently\n3. **Maintainability**: Changes to rendering don't affect tree logic\n4. **Extensibility**: Easy to add new output formats (PDF, HTML) by creating new Layer 3 implementations\n5. **Performance**: Page table only recalculates when height changes or tree changes\n\n## Implementation Tasks\n\n- [ ] Define clear boundaries between layers with proper types\n- [ ] Refactor TreeNode to be pure data (Layer 1)\n- [ ] Create PageTable struct that references TreeNode (Layer 2)\n- [ ] Implement page table building with parent context injection\n- [ ] Simplify draw_tree to just render from page table (Layer 3)\n- [ ] Update navigation methods to work with page table\n- [ ] Ensure page table rebuilds on height change or filter change\n"
  }
}